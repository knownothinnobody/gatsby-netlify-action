# Gatsby Publish

GitHub Action to build and deploy your Gatsby site to GitHub Pages â¤ï¸ðŸŽ©

## Usage

This GitHub Action will run `gatsby build` at the root of your repository and
deploy it to GitHub Pages for you! Here's a basic workflow example:

```yml
name: Gatsby Publish

on:
  push:
    branches:
      - dev

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: knownothinnobody/gatsby-netlify-action@v2
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
```

> **NOTE:** In order to support `npm` and `yarn`, this Action relies on having a
> `build` script defined in your `package.json` file. Gatsby automatically defines
> this script whenever you start a new project via `gatsby new`, which in turn calls
> `gatsby build`.

### Knobs & Handles

This Action is fairly simple but it does provide you with a couple of
configuration options:

- **netlify-access-token**: A [Netlify Personal Access Token][netlify-access-token] with
  the `repo` scope. This is **required** to push the site to your repo after
  Gatsby finish building it. You should store this as a [secret][github-repo-secret]
  in your repository. Provided as an [env-variable][github-env-variable].

- **gatsby-args**: Additional arguments that get passed to `gatsby build`. See the
  [Gatsby documentation][gatsby-build-docs] for a list of allowed options.
  Provided as an [input][github-action-input].
  Defaults to nothing.

- **skip-publish**: Builds your Gatsby site but skips publishing by setting it to `true`,
  effectively performing a test of the build process using the live configuration.
  Provided as an [input][github-action-input]
  Defaults to **false**

### Path Prefix

You need to tell Gatsby what the path prefix is via `gatsby-config.js`:

```js
module.exports = {
  pathPrefix: "/example",
}
```

Additionally, you need to tell the `gatsby build` command to use it by passing
the `--prefix-paths` as an argument. Here's an example workflow for that:

```yml
name: Gatsby Publish

on:
  push:
    branches:
      - dev

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: knownothinnobody/gatsby-netlify-action@v2
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        with:
          gatsby-args: --prefix-paths
```

###  Validation on Pull Request

Provides build validation on `pull request` if required:

```yml
name: Gatsby Publish

on:
  pull-request:
    branches:
      - dev

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: knownothinnobody/gatsby-gh-pages-action@v2
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        with:
          gatsby-args: --prefix-paths
          skip-publish: true
```

### CNAME

You have a custom domain you would like to use? Fancy! ðŸ˜Ž This Action's got you
covered! Assuming you have already set up your DNS provider as defined in the
[GitHub Pages docs][github-pages-domain-docs], all we need next is a `CNAME`
file at the root of your project with the domain you would like to use. For
example:

```CNAME
imenrique.com
```

> Notice that it's **all capitals CNAME** ðŸ˜Š.

This is how GitHub keeps track of the domain you want to use. This action will
copy the file to the `public` directory generated by Gatsby before pushing your
site so that the domain is persisted between deploys.

### Assumptions

This Action assumes that your Gatsby code sits at the root of your repository
and `gatsby build` outputs to the `public` directory. As of this writing, Gatsby
doesn't provide a way to customize the build directory so this should be a safe
assumption.

Additionally, a `build` script on `package.json` is expected for this Action to
to work (as mentioned at the beginning). Ultimately, this is what calls `gatsby build`.

Finally, this script needs a `netlify.toml` at the root of your project in order to deploy properly.

## That's It

Have fun building! âœ¨

[gatsby-build-docs]: https://www.gatsbyjs.org/docs/gatsby-cli/#build
[github-access-token]: https://help.github.com/articles/creating-a-personal-access-token-for-the-command-line
[github-env-variable]: https://help.github.com/en/actions/configuring-and-managing-workflows/using-environment-variables
[github-action-input]: https://help.github.com/en/actions/automating-your-workflow-with-github-actions/creating-and-using-encrypted-secrets#using-encrypted-secrets-in-a-workflow
[github-pages-domain-docs]: https://help.github.com/en/articles/using-a-custom-domain-with-github-pages
[github-repo-secret]: https://help.github.com/en/actions/automating-your-workflow-with-github-actions/creating-and-using-encrypted-secrets#creating-encrypted-secrets
